<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM Screen Search Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #4a5f4e;
            color: #90EE90;
        }
        .error {
            background: #5f4a4a;
            color: #ff9090;
        }
        .info {
            background: #3a3a4a;
            color: #ffffff;
        }
        .search-box {
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background: #2a2a3a;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            background: #2a2a3a;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result-item {
            padding: 5px;
            margin: 5px 0;
            background: #3a3a4a;
            border-radius: 3px;
        }
        pre {
            background: #2a2a3a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>DM Screen Search Functionality Test</h1>

    <div id="url-info" class="status info"></div>
    <div id="path-info" class="status info"></div>
    <div id="status" class="status info">Initializing...</div>

    <div class="search-box">
        <input type="text" id="search-input" placeholder="Type to search (e.g., 'dragon', 'fireball', 'stunned')" disabled>
    </div>

    <div id="results" class="results" style="display:none;"></div>

    <h2>Debug Console</h2>
    <pre id="console"></pre>

    <script type="module">
        // Debug logging
        const debugLog = (message, type = 'info') => {
            const consoleEl = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            consoleEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.log(message);
        };

        // Show current URL info
        document.getElementById('url-info').textContent = `Current URL: ${window.location.href}`;
        document.getElementById('path-info').textContent = `Protocol: ${window.location.protocol} | Host: ${window.location.host}`;

        try {
            debugLog('Starting test...');

            // Import the data loader
            debugLog('Importing data-loader module...');
            const { default: dataLoader } = await import('./js/data-loader.js');

            debugLog(`Base path detected: ${dataLoader.basePath}`);

            // Try to load data
            debugLog('Loading data files...');
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Loading data files...';

            await dataLoader.loadAll();

            const data = dataLoader.getAllData();
            const successMsg = `‚úÖ Data loaded successfully! ${data.monsters.length} monsters, ${data.spells.length} spells, ${data.conditions.length} conditions`;

            statusEl.className = 'status success';
            statusEl.textContent = successMsg;
            debugLog(successMsg, 'success');

            // Enable search
            const searchInput = document.getElementById('search-input');
            searchInput.disabled = false;
            searchInput.placeholder = 'Search is ready! Try searching for "dragon", "fireball", or "stunned"';

            // Set up search functionality
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                const resultsEl = document.getElementById('results');

                if (query.length < 2) {
                    resultsEl.style.display = 'none';
                    return;
                }

                const results = dataLoader.search(query);
                const totalResults = results.monsters.length + results.spells.length + results.conditions.length;

                if (totalResults === 0) {
                    resultsEl.innerHTML = '<div class="result-item">No results found</div>';
                } else {
                    let html = `<strong>Found ${totalResults} results:</strong><br><br>`;

                    if (results.monsters.length > 0) {
                        html += `<strong>Monsters (${results.monsters.length}):</strong><br>`;
                        results.monsters.slice(0, 10).forEach(m => {
                            html += `<div class="result-item">üêâ ${m.name} (CR ${m.cr})</div>`;
                        });
                        if (results.monsters.length > 10) {
                            html += `<div class="result-item">...and ${results.monsters.length - 10} more monsters</div>`;
                        }
                    }

                    if (results.spells.length > 0) {
                        html += `<br><strong>Spells (${results.spells.length}):</strong><br>`;
                        results.spells.slice(0, 10).forEach(s => {
                            html += `<div class="result-item">‚ú® ${s.name} (Level ${s.level}, ${s.school})</div>`;
                        });
                        if (results.spells.length > 10) {
                            html += `<div class="result-item">...and ${results.spells.length - 10} more spells</div>`;
                        }
                    }

                    if (results.conditions.length > 0) {
                        html += `<br><strong>Conditions (${results.conditions.length}):</strong><br>`;
                        results.conditions.forEach(c => {
                            html += `<div class="result-item">‚ö†Ô∏è ${c.name}</div>`;
                        });
                    }

                    resultsEl.innerHTML = html;
                }

                resultsEl.style.display = 'block';
                debugLog(`Search for "${query}" returned ${totalResults} results`);
            });

            debugLog('Search test ready! Try typing in the search box.', 'success');

        } catch (error) {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status error';
            statusEl.textContent = `‚ùå Error: ${error.message}`;
            debugLog(`Error: ${error.message}`, 'error');
            debugLog(`Stack: ${error.stack}`, 'error');

            // Provide helpful instructions
            if (error.message.includes('file://')) {
                debugLog('\nüìå SOLUTION: You need to run a local web server. Try one of these:', 'info');
                debugLog('   1. In VS Code: Use the "Live Server" extension', 'info');
                debugLog('   2. Python: Run "python -m http.server 8000" in this directory', 'info');
                debugLog('   3. Node.js: Run "npx http-server" in this directory', 'info');
                debugLog('   Then access http://localhost:8000/projects/dnd-dm-screen/test-search.html', 'info');
            } else if (error.message.includes('404') || error.message.includes('Failed to load')) {
                debugLog('\nüìå ISSUE: Data files not found. Checking paths...', 'info');
                debugLog(`   Looking for files in: ${dataLoader.basePath}data/`, 'info');
                debugLog('   Ensure these files exist:', 'info');
                debugLog('   - data/monsters.json', 'info');
                debugLog('   - data/spells.json', 'info');
                debugLog('   - data/conditions.json', 'info');
                debugLog('   - data/dc-table.json', 'info');
            }
        }
    </script>
</body>
</html>